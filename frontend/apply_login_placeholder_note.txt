import { NextResponse } from "next/server";

export function middleware(request: Request & { nextUrl: URL; cookies: any }) {
  const url = request.nextUrl as unknown as URL;
  const pathname = (url as any).pathname as string;

  // Allow login page and Next.js internals
  const isPublicPath =
    pathname.startsWith("/login") ||
    pathname.startsWith("/api") ||
    pathname.startsWith("/_next") ||
    pathname.startsWith("/public") ||
    pathname === "/favicon.ico";

  if (isPublicPath) return NextResponse.next();

  const hasGuest = (request as any).cookies?.get?.("guest");

  if (!hasGuest) {
    const redirectUrl = new URL("/login", (request as any).url);
    return NextResponse.redirect(redirectUrl);
  }

  return NextResponse.next();
}

export const config = {
  matcher: [
    "/((?!_next|api|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp|ico)).*)",
  ],
};


